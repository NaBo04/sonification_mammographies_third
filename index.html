<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonification_Mammographies</title>
    <link rel="stylesheet" href="styles.css">
    <script src="./lib/fabric.js"></script>
    <script src="faust/mockDSP/mockDSP.js"></script>
</head>
<body>
    <script>
        
if (typeof (WebAssembly) === "undefined") { //Alerta que aparece en el navegador si no soporta WebAssembly
    alert("WebAssembly is not supported in this browser, the page will not work !")
}

var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined"); //Para verificar el tipo de API de audio que usa el navegador
var audio_context = (isWebKitAudio) ? new webkitAudioContext({ latencyHint: 0.00001 }) : new AudioContext({ latencyHint: 0.00001 }); //Según lo anterior se inicia el audio de una manera u otra
audio_context.destination.channelInterpretation = "discrete"; //Canales de audio independientes

var mock_dsp = null; //Esta variable es para guardar el nodo de audio DSP (Digitla Signal Procesing)

function toggleMute() //Esta funcion es para manejar el valor de un parametro de mock_dsp
{
    var val = event.target.value; //Lee el valor de algún input o slider
    mock_dsp.setParamValue("/audiogen/mute", val); //Añade este valor al mock_dsp
}

function changeMean(event) //Lo mismo para mean
{
    var val = event.target.value;
    val = parseFloat(val);
    mock_dsp.setParamValue("/audiogen/vol", val);
}

function changeStdDev(event) //Lo mismo para std dev
{
    var val = event.target.value;
    val = parseFloat(val);
    mock_dsp.setParamValue("/audiogen/noise", val);
}

function changeSkewness(event) //Lo mismo para skewness
{
    var val = event.target.value;
    val = parseFloat(val);
    mock_dsp.setParamValue("/audiogen/freq", val);
}

function changeKurtosis(event) //Lo mismo para kurtosis
{
    var val = event.target.value;
    val = parseFloat(val);
    mock_dsp.setParamValue("/audiogen/tempo", val);
}

function startmockDSP()
{
    var pluginURL = ".";
    var plugin = new FaustmockDSP(audio_context, pluginURL); //Plugin de mockDSP.js que conecta un sintetizador o procesador de audio
    plugin.load().then(node => { //Para cargar el plugin en un nodo
                            mock_dsp = node; //lo carga en la variable creada antes
                            mock_dsp.connect(audio_context.destination); //conecta el nodo directamente a la salida de antes
                      });
    // const ctx = new AudioContext();
    // const osc = ctx.createOscillator();
    // osc.connect(ctx.destination);
    // osc.start();
}

window.addEventListener('load', startmockDSP); //Carga la funcion startmockDSP una vez haya cargado la pagina por completo

window.addEventListener('touchstart', function() { //Funcion ante toque en pantalla de IOS
                        if (audio_context.state !== "suspended") return; //Si no esta suspendido se acaba
                        var buffer = audio_context.createBuffer(1, 1, 22050); //Crea un buffer vacio
                        var source = audio_context.createBufferSource(); //Fuente de Buffer
                        source.buffer = buffer
                        source.connect(audio_context.destination); //Conecta el buffer a la salida
                        source.start(); //Lo reproduce
                        audio_context.resume().then(() => console.log("Audio resumed")); //Continua con el audio que estaba suspendido
                        }, false);

window.addEventListener("mousedown", () => { //Relaciona una funcion al evento de hacer click con el mouse
    if (audio_context.state !== "suspended") return; //Si el audio estaba suspendido
    audio_context.resume().then(() => console.log("Audio resumed")) //Lo retorna
});  

    </script>

<b>Controles</b>
<ul>
    <li>Puedes hacer zoom con la rueda del mouse.</li>
    <li>Puedes moverle en la imagen manteniendo presionada la rueda del mouse. (No está funcionando)</li>
    <li>Alternativamente puedes moverte manteniendo presionada la barra espaciadora y moviendo el mouse.</li>
    <li>Puedes cambiar el tamaño del selector usando el <i>slider</i> de abajo.</li>
</ul>
<div style="display: flex;">
    <canvas id="rasterCanvas"></canvas>
    <div id="arrayDisplay"></div>
    <script src="canvas.js"></script>
</div>
<div style="padding-top: 25px;">
    <input type="range" id="mySlider" min="0" max="200" value="100" oninput="updateSliderValue(this.value)">
    <span id="sliderValue">100</span>
</div>
    <script src="sonification.js"></script>
</body>
</html>