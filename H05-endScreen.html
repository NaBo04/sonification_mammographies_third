<!DOCTYPE html>
<html>
<head>
    <title>End Screen</title>
    <link rel="stylesheet" href="S05-styleEndScreen.css">
</head>
<body>
    <div id="centralBlock" class="contenido">
        <h1 id="mainText">Test Finalizado</h1>
        <h2 id="message">Tus respuestas se han guardado.</h2>
        <button class="downloadButton" id="downloadButton" onclick="downloadAnswers()">Descargar Respuestas</button>
        <div style="padding-top: 15px;">
            <button class="nextButton" id="nextButton">Continuar</button>
            <button class="back-button" id="backButton">Cambiar de Usuario</button>
        </div>
    </div>

    <script>
        var userAnswers = JSON.parse(sessionStorage.getItem('userAnswers'));
        if (userAnswers[1].length == 45 && userAnswers[2].length == 45 && userAnswers[3].length == 2) {
            document.getElementById("mainText").innerText = "Todos los tests finalizados";
            document.getElementById("message").innerText = "Muchas gracias por tu participación.";
        }

        document.getElementById('nextButton').addEventListener('click', function() {
            window.location.href = 'H01-testSelection.html';
        });

        document.getElementById('backButton').addEventListener('click', function() {
            window.location.href = 'H00-startScreen.html';
        });

        function downloadAnswers() {
            if (userAnswers == null) {
                alert('No se ha iniciado sesión. Por favor reiniciar.');
                return;
            }
            let contenido = `Usuario;${userAnswers[0]}\n`;
            contenido += '\ntest 1\nimagen;tiempo;sonificacion;nivel de seguridad;respuesta\n';
            for (let answer of userAnswers[1]) {
                contenido += `${answer[0]};${answer[1]};${answer[2]};${answer[3]};${answer[4]}\n`;
            }
            contenido += '\ntest 2\nimagen;tiempo;sonificacion;nivel de seguridad;cuadrados\n';
            for (let answer of userAnswers[2]) {
                contenido += `${answer[0]};${answer[1]};${answer[2]};${answer[3]};${answer[4]}\n`;
            }
            contenido += '\ntest 3\nimagen;tiempo;sonificacion;nivel de seguridad;cuadrados\n';
            for (let answer of userAnswers[3]) {
                contenido += `${answer[0]};${answer[1]};${answer[2]};${answer[3]};${answer[4]}\n`;
            }
            const blob = new Blob([contenido], { type: 'text/csv' });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${userAnswers[0]}_Answers.csv`; //Quiero que el archivo se llame segun el nombre de usuario

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>