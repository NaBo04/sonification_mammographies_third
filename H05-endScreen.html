<!DOCTYPE html>
<html>
<head>
    <title>End Screen</title>
    <link rel="stylesheet" href="S05-styleEndScreen.css">
</head>
<body>
    <div id="centralBlock" class="contenido">
        <h1 id="mainText">Test Finalizado</h1>
        <h2 id="message">Tus respuestas se han guardado.</h2>
        <div style="padding-top: 15px;">
            <button class="nextButton" id="nextButton">Continuar</button>
            <button class="back-button" id="backButton">Cambiar de Usuario</button>
        </div>
    </div>
    
    <script>
        var userAnswers = JSON.parse(sessionStorage.getItem('userAnswers'));
        var nombreArchivo = "default";

        document.getElementById('nextButton').addEventListener('click', function() {
            window.location.href = 'H01-testSelection.html';
        });
        document.getElementById('backButton').addEventListener('click', function() {
            window.location.href = 'H00-startScreen.html';
        });
        
        let contenido = `Usuario;${userAnswers[0]}\n`;
        if (userAnswers[1].length == 45 && userAnswers[2].length == 0 && userAnswers[3].length == 0) {
            contenido += '\ntest 1\nimagen;tiempo;sonificacion;nivel de seguridad;respuesta\n';
            for (let answer of userAnswers[1]) {
                contenido += `${answer[0]};${answer[1]};${answer[2]};${answer[3]};${answer[4]}\n`;
            }
            nombreArchivo = `Test1_${userAnswers[0]}_Answers.csv`; 
        }
        else if (userAnswers[1].length == 45 && userAnswers[2].length == 45 && userAnswers[3].length == 0) {
            contenido += '\ntest 2\nimagen;tiempo;sonificacion;nivel de seguridad;cuadrados\n';
            for (let answer of userAnswers[2]) {
                contenido += `${answer[0]};${answer[1]};${answer[2]};${answer[3]};${answer[4]}\n`;
            }
            nombreArchivo = `Test2_${userAnswers[0]}_Answers.csv`; 
        }
        else if (userAnswers[1].length == 45 && userAnswers[2].length == 45 && userAnswers[3].length == 2) {
            contenido += '\ntest 3\nimagen;tiempo;sonificacion;nivel de seguridad;cuadrados\n';
            for (let answer of userAnswers[3]) {
                contenido += `${answer[0]};${answer[1]};${answer[2]};${answer[3]};${answer[4]}\n`;
            }
            nombreArchivo = `Test3_${userAnswers[0]}_Answers.csv`; 
            document.getElementById("mainText").innerText = "Todos los tests finalizados";
            document.getElementById("message").innerText = "Muchas gracias por tu participaci√≥n.";
        } 
        else {
            contenido += 'Error';
        }

        const blob = new Blob([contenido], { type: 'text/csv' });
        const archivoCSV = new File([blob], nombreArchivo, { type: 'text/csv' });
        const formData = new FormData();
        formData.append('archivo', archivoCSV);
            
        fetch('http://localhost:5000/subir', {
            method: 'POST',
            body: formData
        })
        
    </script>
</body>
</html>